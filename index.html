<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Bingo Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .bingo-grid {
            display: grid;
            width: 100%;
            aspect-ratio: 1 / 1;
            border: 4px solid #000;
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .header-cell {
            background-color: #1e293b;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 2rem;
            border: 1px solid #000;
            text-transform: uppercase;
            overflow: hidden;
        }

        .bingo-cell {
            border: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 4px;
            cursor: text;
            overflow: hidden;
            word-break: break-word;
            flex-direction: column; 
            outline: none;
            transition: background-color 0.2s;
        }

        .bingo-cell:focus { background-color: #f0f9ff; }
        
        .bingo-cell:empty::before {
            content: 'Click to edit';
            color: #cbd5e1;
            font-size: 1rem;
            pointer-events: none;
        }
        .bingo-cell:focus::before { content: ''; }

        @media print {
            @page { margin: 0.5cm; size: portrait; }
            body { background-color: white; height: 100vh; margin: 0; padding: 0; overflow: hidden; }
            .no-print { display: none !important; }
            #app-container { max-width: 100% !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; }
            .bingo-grid { width: 100%; height: 95vh; border: 4px solid #000; box-shadow: none; }
            .header-cell { background-color: #000 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bingo-cell:empty::before { content: ''; }
        }

        #toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #1e293b;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8">

    <div id="toast">Link copied to clipboard!</div>

    <div id="app-container" class="w-full max-w-4xl px-4 flex flex-col gap-6">
        
        <div class="no-print bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Bingo Board Generator</h1>
                    <p class="text-sm text-gray-500 mt-1">Share links preserve all text and settings.</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="window.print()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>
                        Print
                    </button>
                    <button onclick="generateShareLink()" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        Share Link
                    </button>
                    <button onclick="resetBoard()" class="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition border border-gray-300">
                        Reset
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">Grid Size (N x N)</label>
                    <input type="number" id="gridSizeInput" min="3" max="10" value="5" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" onchange="updateConfig()">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">Header Text</label>
                    <input type="text" id="headerTextInput" value="BINGO" maxlength="10" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition uppercase" oninput="this.value = this.value.toUpperCase(); updateConfig()">
                </div>
                <div class="flex items-center gap-2">
                     <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="centerFreeSpace" class="sr-only peer" onchange="updateConfig()">
                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        <span class="ms-3 text-sm font-medium text-gray-700">Add Free Space (Center)</span>
                      </label>
                </div>
            </div>
        </div>

        <div id="board-area" class="w-full flex justify-center bg-white p-1 md:p-8 rounded-xl shadow-sm md:shadow-lg border border-gray-200">
            <div id="bingoGrid" class="bingo-grid"></div>
        </div>
    </div>

    <script>
        const DEFAULT_CONFIG = { size: 5, headerText: "BINGO", hasFreeSpace: true, cells: {} };
        let currentConfig = { ...DEFAULT_CONFIG };

        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            renderBoard();
            
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(adjustAllFonts, 200);
            });
        });

        function loadConfig() {
            // Check URL parameters first
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');

            if (dataParam) {
                try {
                    // Use decodeURIComponent and escape to handle non-latin characters in base64
                    const decodedData = decodeURIComponent(escape(atob(dataParam)));
                    currentConfig = JSON.parse(decodedData);
                    // Clear the URL parameter after loading to keep it clean (optional)
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (e) {
                    console.error("Failed to load data from URL", e);
                }
            } else {
                const saved = localStorage.getItem('bingoConfig');
                if (saved) {
                    try { currentConfig = JSON.parse(saved); } 
                    catch (e) { console.error("Failed to parse saved config", e); }
                }
            }
            
            document.getElementById('gridSizeInput').value = currentConfig.size;
            document.getElementById('headerTextInput').value = currentConfig.headerText;
            document.getElementById('centerFreeSpace').checked = currentConfig.hasFreeSpace;
        }

        function saveConfig() {
            localStorage.setItem('bingoConfig', JSON.stringify(currentConfig));
        }

        function generateShareLink() {
            try {
                const jsonStr = JSON.stringify(currentConfig);
                const encodedData = btoa(unescape(encodeURIComponent(jsonStr)));
                const shareUrl = `${window.location.origin}${window.location.pathname}?data=${encodedData}`;
                
                // Copy to clipboard
                const el = document.createElement('textarea');
                el.value = shareUrl;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                
                showToast();
            } catch (e) {
                console.error("Error generating share link", e);
            }
        }

        function showToast() {
            const toast = document.getElementById('toast');
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        }

        function updateConfig() {
            currentConfig.size = Math.max(1, parseInt(document.getElementById('gridSizeInput').value) || 5);
            currentConfig.headerText = document.getElementById('headerTextInput').value;
            currentConfig.hasFreeSpace = document.getElementById('centerFreeSpace').checked;
            saveConfig();
            renderBoard();
        }

        function resetBoard() {
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
                    <div style="background:white;padding:2rem;border-radius:1rem;max-width:400px;text-align:center;">
                        <h2 style="font-weight:bold;font-size:1.25rem;margin-bottom:1rem;">Clear everything?</h2>
                        <div style="display:flex;gap:1rem;justify-content:center;">
                            <button id="confirmReset" style="background:#ef4444;color:white;padding:0.5rem 1.5rem;border-radius:0.5rem;">Reset</button>
                            <button id="cancelReset" style="background:#e2e8f0;padding:0.5rem 1.5rem;border-radius:0.5rem;">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('confirmReset').onclick = () => {
                currentConfig = { ...DEFAULT_CONFIG, cells: {} };
                localStorage.removeItem('bingoConfig');
                loadConfig();
                renderBoard();
                document.body.removeChild(modal);
            };
            document.getElementById('cancelReset').onclick = () => document.body.removeChild(modal);
        }

        function handleCellInput(row, col, text) {
            currentConfig.cells[`${row}-${col}`] = text;
            saveConfig();
        }

        function renderBoard() {
            const grid = document.getElementById('bingoGrid');
            const size = currentConfig.size;
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            grid.style.gridTemplateRows = `auto repeat(${size}, 1fr)`;

            const headerText = currentConfig.headerText || "";
            for (let i = 0; i < size; i++) {
                const char = headerText[i % headerText.length] || "";
                const cell = document.createElement('div');
                cell.className = 'header-cell';
                cell.innerText = char;
                grid.appendChild(cell);
            }

            const center = Math.floor(size / 2);
            const isOdd = size % 2 !== 0;

            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'bingo-cell';
                    cell.contentEditable = true;
                    
                    const isCenter = isOdd && r === center && c === center;
                    if (currentConfig.hasFreeSpace && isCenter) {
                        if (!currentConfig.cells[`${r}-${c}`]) currentConfig.cells[`${r}-${c}`] = "FREE SPACE";
                        cell.style.backgroundColor = "#e2e8f0";
                        cell.style.fontWeight = "bold";
                    }

                    cell.innerText = currentConfig.cells[`${r}-${c}`] || "";

                    cell.oninput = (e) => {
                        handleCellInput(r, c, e.target.innerText);
                        fitTextToContainer(e.target);
                    };
                    
                    cell.onpaste = (e) => {
                        e.preventDefault();
                        const text = (e.clipboardData || window.clipboardData).getData('text');
                        document.execCommand("insertHTML", false, text);
                    };

                    grid.appendChild(cell);
                    setTimeout(() => fitTextToContainer(cell), 0);
                }
            }
        }

        function adjustAllFonts() {
            document.querySelectorAll('.bingo-cell').forEach(fitTextToContainer);
        }

        function fitTextToContainer(el) {
            if (!el.innerText.trim()) return;
            const maxHeight = el.clientHeight;
            const maxWidth = el.clientWidth;
            if (maxHeight === 0 || maxWidth === 0) return;

            let fontSize = maxHeight * 0.8;
            el.style.fontSize = `${fontSize}px`;
            el.style.lineHeight = "1.1";

            while ((el.scrollHeight > maxHeight || el.scrollWidth > maxWidth) && fontSize > 8) {
                fontSize -= 1;
                el.style.fontSize = `${fontSize}px`;
            }
        }
    </script>
</body>
</html>
